{"version":3,"file":"filtersform.min.js","sources":["../src/filtersform.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to retrieve the filter form and put it in the right location.\n * This will also make sure that submit of this form will be sent to the filter form.\n *\n * @copyright  2020 CALL Learning 2020 - Laurent David laurent@call-learning.fr\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/config'], function($, config) {\n\n    /**\n     * FilterForm class.\n     *\n     * @class FilterForm\n     * @param {String} selector The selector for the form\n     */\n    var FiltersForm = {};\n\n    /**\n     * Refresh after\n     * @param {String} target selector The selector for the form\n     * @param {Bool} ignoresesskey Ignore the sesskey in the form.\n     * @return {Object|Bool} Filter data or false if sesskey is not confirmed.\n     */\n    function getFilterData(target, ignoresesskey) {\n        var data = $(target).serializeArray();\n        var filterdata = {};\n        // Check sesskey (if not ignore request).\n        var sesskeyconfirmed = false;\n        data.forEach(function(d) {\n            if (d.name === 'sesskey') {\n                sesskeyconfirmed = d.value === config.sesskey;\n            } else {\n                var parsename = d.name.match(/(customfield_)?(\\w+)\\[(\\w+)\\]\\[?(\\w*)\\]?/);\n                if (parsename) {\n                    var hasCustomShortName = false;\n                    if (parsename.length >= 4) { // This is a customfield (value, operator, type).\n                        parsename.shift();\n                        hasCustomShortName = true;\n                    }\n                    var rootname = parsename[1];\n                    var type = parsename[2];\n                    if (filterdata[rootname] === undefined) {\n                        filterdata[rootname] = {};\n                    }\n                    if (hasCustomShortName && filterdata[rootname].shortname === undefined) {\n                        Object.defineProperty(filterdata[rootname], 'shortname', {\n                            enumerable: true, // For JSON Stringify.\n                            value: rootname\n                        });\n                    }\n                    if (d.value != \"_qf__force_multiselect_submission\") { // Specific case for multiselect\n                        if (typeof filterdata[rootname].value == \"undefined\"\n                        ) {\n                            Object.defineProperty(filterdata[rootname], type, {\n                                enumerable: true, // For JSON Stringify.\n                                value: d.value,\n                                writable: true\n                            });\n                        } else {\n                            filterdata[rootname].value += ',' + d.value;\n                        }\n                    }\n                }\n            }\n        });\n        var filterdataarray = Object.values(filterdata).filter(function(v) {\n            // For date type there is a fourth parameter which should be equal to 1\n            // whenever the box is checked.\n            if (v.type == 'date' && v.value !== undefined) {\n                return v.value.split(\",\").length > 3; // We have 3 commas: there should be a 1 at the end (enabled).\n            }\n            return v.value !== undefined || (v.value === null);\n        }); // Remove filters for which value is undefined or null.\n        if (sesskeyconfirmed || ignoresesskey) {\n            return filterdataarray;\n        }\n        return false;\n    }\n    FiltersForm.init = function(selector) {\n        var target = $(selector);\n        // Remove any attempt to submit the form for real.\n        target.on('submit', 'form', function(e) {\n            e.preventDefault();\n            // Now we get all the current values from the form.\n            var filterdataarray = getFilterData(target.children('form'), false);\n            if (filterdataarray) {\n                $(document).trigger('resourcelibrary-filters-change', [filterdataarray]);\n            }\n        });\n        $('#id_resetbutton').on('click', function() {\n            $(target).children('form.resourcelibrary-filters-form')[0].reset();\n        });\n        var filterdataarray = getFilterData(target.children('form'), true);\n        $(document).trigger('resourcelibrary-filters-inited', [filterdataarray]); // Filter are now initialised.\n    };\n    return FiltersForm;\n});\n"],"names":["define","$","config","FiltersForm","getFilterData","target","ignoresesskey","data","serializeArray","filterdata","sesskeyconfirmed","forEach","d","name","value","sesskey","parsename","match","hasCustomShortName","length","shift","rootname","type","undefined","shortname","Object","defineProperty","enumerable","writable","filterdataarray","values","filter","v","split","init","selector","on","e","preventDefault","children","document","trigger","reset"],"mappings":";;;;;;;AAsBAA,OAAM,oCAAC,CAAC,SAAU,gBAAgB,SAASC,EAAGC,QAQ1C,IAAIC,YAAc,CAAA,EAQlB,SAASC,cAAcC,OAAQC,eAC3B,IAAIC,KAAON,EAAEI,QAAQG,iBACjBC,WAAa,CAAA,EAEbC,kBAAmB,EACvBH,KAAKI,SAAQ,SAASC,GAClB,GAAe,YAAXA,EAAEC,KACFH,iBAAmBE,EAAEE,QAAUZ,OAAOa,YACnC,CACH,IAAIC,UAAYJ,EAAEC,KAAKI,MAAM,4CAC7B,GAAID,UAAW,CACX,IAAIE,oBAAqB,EACrBF,UAAUG,QAAU,IACpBH,UAAUI,QACVF,oBAAqB,GAEzB,IAAIG,SAAWL,UAAU,GACrBM,KAAON,UAAU,QACQO,IAAzBd,WAAWY,YACXZ,WAAWY,UAAY,IAEvBH,yBAAyDK,IAAnCd,WAAWY,UAAUG,WAC3CC,OAAOC,eAAejB,WAAWY,UAAW,YAAa,CACrDM,YAAY,EACZb,MAAOO,WAGA,qCAAXT,EAAEE,aACuC,IAA9BL,WAAWY,UAAUP,MAE5BW,OAAOC,eAAejB,WAAWY,UAAWC,KAAM,CAC9CK,YAAY,EACZb,MAAOF,EAAEE,MACTc,UAAU,IAGdnB,WAAWY,UAAUP,OAAS,IAAMF,EAAEE,MAGlD,CACJ,CACJ,IACA,IAAIe,gBAAkBJ,OAAOK,OAAOrB,YAAYsB,QAAO,SAASC,GAG5D,MAAc,QAAVA,EAAEV,WAA8BC,IAAZS,EAAElB,MACfkB,EAAElB,MAAMmB,MAAM,KAAKd,OAAS,OAEpBI,IAAZS,EAAElB,OAAoC,OAAZkB,EAAElB,KACvC,IACA,SAAIJ,mBAAoBJ,gBACbuB,eAGf,CAkBA,OAjBA1B,YAAY+B,KAAO,SAASC,UACxB,IAAI9B,OAASJ,EAAEkC,UAEf9B,OAAO+B,GAAG,SAAU,QAAQ,SAASC,GACjCA,EAAEC,iBAEF,IAAIT,gBAAkBzB,cAAcC,OAAOkC,SAAS,SAAS,GACzDV,iBACA5B,EAAEuC,UAAUC,QAAQ,iCAAkC,CAACZ,iBAE/D,IACA5B,EAAE,mBAAmBmC,GAAG,SAAS,WAC7BnC,EAAEI,QAAQkC,SAAS,qCAAqC,GAAGG,OAC/D,IACA,IAAIb,gBAAkBzB,cAAcC,OAAOkC,SAAS,SAAS,GAC7DtC,EAAEuC,UAAUC,QAAQ,iCAAkC,CAACZ,mBAEpD1B,WACX"}