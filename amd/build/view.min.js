/**
 * Manage the courses or course modules view for the Resource Library.
 *
 * Inspired from the Course overview block.
 * @copyright  2020 CALL Learning 2020 - Laurent David laurent@call-learning.fr
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_resourcelibrary/view",["jquery","local_resourcelibrary/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","local_resourcelibrary/selectors","core/paged_content_events"],(function($,Repository,PagedContentFactory,PubSub,CustomEvents,Notification,Templates,CourseEvents,Selectors,PagedContentEvents){var TEMPLATES_ENTITES_CARDS="local_resourcelibrary/view-cards",TEMPLATES_ENTITIES_LIST="local_resourcelibrary/view-list",TEMPLATES_NOENTITIES="local_resourcelibrary/no-entities",NUMCOURSES_PERPAGE=[12,24,48],loadedPages=[],lastPage=0,lastLimit=0,namespace=null,currentFilters=[],entityType="course",categoryId=0,getDisplayModifierValues=function(root){var entityRegion=root.find(Selectors.entityView.region);return{display:entityRegion.attr("data-display"),sort:{column:entityRegion.attr("data-sort-column"),order:entityRegion.attr("data-sort-order")},displaycategories:entityRegion.attr("data-displaycategories")}},DEFAULT_PAGED_CONTENT_CONFIG={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"local_resourcelibrary_user_paging_preference"},renderEntities=function(root,pageData){var entities=[];void 0!==pageData.entities&&(entities=pageData.entities);var filters=getDisplayModifierValues(root),currentTemplate="";if(currentTemplate="list"===filters.display?TEMPLATES_ENTITIES_LIST:TEMPLATES_ENTITES_CARDS,"on"!==filters.displaycategories&&(entities=entities.map((function(entity){return delete entity.category,entity}))),entities.length)return Templates.render(currentTemplate,{entities:entities});var noentitiesimg=root.find(Selectors.entityView.region).attr("data-noentitiesimg");return Templates.render(TEMPLATES_NOENTITIES,{noentitiesimg:noentitiesimg})},setLimit=function(limit){this.find(Selectors.entityView.region).attr("data-paging",limit)},registerPagedEventHandlers=function(root,namespace){var event=namespace+PagedContentEvents.SET_ITEMS_PER_PAGE_LIMIT;PubSub.subscribe(event,setLimit.bind(root))},initializePagedContent=function(root){namespace="local_resourcelibrary"+root.attr("id")+"_"+Math.random();var itemsPerPage=function(rootNode){var itemsPerPage=NUMCOURSES_PERPAGE,pagingLimit=parseInt(rootNode.find(Selectors.entityView.region).attr("data-paging"),10);return pagingLimit&&(itemsPerPage=NUMCOURSES_PERPAGE.map((function(value){var active=!1;return value===pagingLimit&&(active=!0),{value:value,active:active}}))),itemsPerPage}(root),modifiers=getDisplayModifierValues(root),config=$.extend({},DEFAULT_PAGED_CONTENT_CONFIG);config.eventNamespace=namespace;var pagedContentPromise=PagedContentFactory.createWithLimit(itemsPerPage,(function(pagesData,actions){var promises=[];return pagesData.forEach((function(pageData){var currentPage=pageData.pageNumber,limit=pageData.limit;if(lastLimit!==limit&&(loadedPages=[],lastPage=0),lastPage===currentPage)return actions.allItemsLoaded(lastPage),void promises.push(renderEntities(root,loadedPages[currentPage]));lastLimit=limit;var pagePromise=function(modifiers,filters,limit,offset){return"course"===entityType?Repository.getFilteredCourseList({categoryid:categoryId,sorting:[{column:modifiers.sort.column,order:modifiers.sort.order}],filters:filters,limit:limit,offset:offset}):Promise.resolve([])}(modifiers,currentFilters,limit,limit*(currentPage-1)).then((function(entities){return loadedPages[currentPage]={entities:entities},loadedPages[currentPage].entities.length<pageData.limit&&(lastPage=currentPage,actions.allItemsLoaded(currentPage)),renderEntities(root,loadedPages[currentPage])})).catch(Notification.exception);promises.push(pagePromise)})),promises}),config);pagedContentPromise.then((function(html,js){return registerPagedEventHandlers(root,namespace),Templates.replaceNodeContents(root.find(Selectors.entityView.region),html,js)})).done((()=>{const rootNode=document.querySelector(Selectors.entityView.region+" .paged-content-page-container");return new MutationObserver((mutationsList=>{mutationsList&&mutationsList.forEach((mutation=>{if("childList"===mutation.type){const event=new CustomEvent("resource_library_card_rendered",{rootNode:rootNode});document.querySelector(Selectors.entityView.region+' .paged-content-page-container [data-region="paged-content-page"]')&&document.dispatchEvent(event)}}))})).observe(rootNode,{childList:!0,subtree:!0}),!0})).catch(Notification.exception)},refresh=function(root){root=$(root),loadedPages=[],lastPage=0,initializePagedContent(root),entityType=root.attr("data-entity-type"),parseInt(root.attr("data-parent-id")),categoryId=parseInt(root.attr("data-category-id")),root.attr("data-init")||(!function(root){CustomEvents.define(root,[CustomEvents.events.activate])}(root),root.attr("data-init",!0))};return{init:function(root){$(document).on("resourcelibrary-filters-inited resourcelibrary-filters-change",function(e,formdata){currentFilters=formdata,this.refresh(root)}.bind(this))},reset:function(root){loadedPages.length>0?loadedPages.forEach((function(entityList,index){var pagedContentPage=function(root,index){return root.find('[data-region="paged-content-page"][data-page="'+index+'"]')}(root,index);renderEntities(root,entityList).then((function(html,js){return Templates.replaceNodeContents(pagedContentPage,html,js)})).catch(Notification.exception)})):refresh(root)},refresh:refresh}}));

//# sourceMappingURL=view.min.js.map